{% load static %}
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbox</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Chat History</h2>
            <button id="newChatBtn" class="new-chat-btn">+</button>
        </div>
        <div class="conversation-list" id="conv_list">
            <!-- conservation-item will be displayed here -->
        </div>   
    </div>

    <div class="main-content">
        <div class="chatbox-header">
            <h2>AIChatBot</h2>
        </div>
        <div class="chatbox-messages" id="chatBox">
            <!-- Messages will be displayed here -->
        </div>
        <div class="chatbox-input">
            <textarea id="userInputEditBox" placeholder="輸入訊息..." ></textarea>
            <div class="footer">
                <button class="send-btn" onclick="sendMessage()">↑</button>
            </div>
        </div>
    </div>

    <script>
        let isChiInput = false;

        // 頁面載入時執行
        document.addEventListener('DOMContentLoaded', function() {
            // 載入歷史對話列表
            loadConversationHistory();
        });

        // 載入歷史對話列表
        function loadConversationHistory() {
            fetch('/api/load_conversation_history/', {
                method: 'GET',
            })
            .then(response => response.json())
            .then(data => {
                if (data.conversations) {
                    const convList = document.getElementById('conv_list');
                    data.conversations.forEach(conv => {
                        let convRow = document.createElement("div");
                        convRow.className = "conversation-item";
                        convRow.id = conv.id;
                        convRow.textContent = conv.title;
                        convList.appendChild(convRow);
                        
                        // 綁定點擊事件
                        convRow.addEventListener("click", function() {
                            fetch(`/api/load_conv/${conv.id}`, {
                                method: "GET",
                            })
                            .then(res => res.json())
                            .then(data => {
                                const chatBox = document.getElementById("chatBox");
                                
                                if (data.need_clear_chatbox === "true") {
                                    chatBox.innerHTML = "";
                                    if (data.conversation_history) {
                                        data.conversation_history.forEach(msg => {
                                            let messageDiv = document.createElement("div");
                                            messageDiv.className = "message";
                                            const bubbleClass = msg.role === 'user' ? 'user' : 'bot';
                                            messageDiv.innerHTML = `<div class="message-bubble ${bubbleClass}">${msg.content}</div>`;
                                            chatBox.appendChild(messageDiv);
                                        });
                                    }
                                }
                                chatBox.scrollTop = chatBox.scrollHeight;
                            });
                        });
                    });
                }
            })
            .catch(error => console.error("Error loading conversation history:", error));
        }

        document.getElementById("userInputEditBox").addEventListener("compositionstart", function(event) {
            isChiInput = true;
        });

        document.getElementById("userInputEditBox").addEventListener("compositionend", function(event) {
            isChiInput = false;
        });

        document.getElementById("userInputEditBox").addEventListener("keydown", function(event) {
            if (event.key === "Enter" && !event.shiftKey && !isChiInput) {
                event.preventDefault();
                sendMessage();
            }
        });

        function sendMessage() {
            // 找到在哪個對話中
            let conv_list = document.querySelector(".conversation-list"); // 使用 querySelector 來獲取單個元素
            console.log(conv_list);
            let divs = conv_list.querySelectorAll('div'); // 然後在該元素內部查找所有 div
            console.log(divs);

            let userInputEditBox = document.getElementById("userInputEditBox");
            let userInputText = userInputEditBox.value.trim();
            if (userInputText === "") return;
            userInputEditBox.value = "";

            let chatBox = document.getElementById("chatBox");

            // **添加用戶訊息**
            let userMessage = document.createElement("div");
            userMessage.className = "message";
            userMessage.innerHTML = `<div class="message-bubble user">${userInputText}</div>`;
            chatBox.appendChild(userMessage);

            // 滾動到最新的消息
            chatBox.scrollTop = chatBox.scrollHeight;

            // 在發送請求前，先創建一個 "..." 的訊息並且開始動畫
            let loadingMessage = document.createElement("div");
            loadingMessage.className = "message";
            loadingMessage.innerHTML = `<div class="message-bubble bot">.</div>`;
            chatBox.appendChild(loadingMessage);

            // 動態更新 loadingMessage 的內容
            let dots = 1;
            let loadingInterval = setInterval(() => {
                dots = (dots % 3) + 1;  // 控制點數在 1 到 3 之間變化
                loadingMessage.innerHTML = `<div class="message-bubble bot">${".".repeat(dots)}</div>`;
            }, 500); // 每 500 毫秒更新一次

            let formData = new FormData();
            formData.append("userInputText", userInputText);
            
            // 將所有 div 的 id 存入 FormData
            Array.from(divs).forEach((div, index) => {
                formData.append(`conv_id_${index}`, div.id);  // 使用唯一的鍵名來區分每個 div id
            });

            // AJAX 請求
            fetch("/sendMessage/", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === "Success") {
                    clearInterval(loadingInterval); 
                    chatBox.removeChild(loadingMessage);
                    
                    // add new conversation
                    if (data.need_add_new_conv) {
                        // 在 sidebar 最上方加一筆 new conversation
                        let conv_row = document.createElement("div");
                        conv_row.className = "conversation-item";
                        conv_row.id = data.conv_id;
                        conv_row.textContent = userInputText;
                        // 使用 insertBefore 將新對話放在列表的最前面
                        conv_list.insertBefore(conv_row, conv_list.firstChild);

                        // ✅ 綁定點擊事件
                        conv_row.addEventListener("click", function () {
                            // 這裡可以載入對應的對話，或打 API
                            console.log("點擊對話 id:", conv_row.id);

                            // 如果要導向某個 API 頁面（GET）
                            // location.href = `/api/load_conv/${this.id}`;

                            // 或 fetch 呼叫 API（GET 範例）
                            fetch(`/api/load_conv/${conv_row.id}`, {
                                 method: "GET",
                                })
                                .then(res => res.json())
                                .then(data => {
                                    console.log("API 回傳資料：", data);
                                    // 在畫面載入對話內容之類的操作
                                    document.getElementById("chatBox").innerHTML = "";
                                    if (data.need_clear_chatbox === "true") {
                                        // 載入歷史對話內容
                                        if (data.conversation_history) {
                                            data.conversation_history.forEach(msg => {
                                                let messageDiv = document.createElement("div");
                                                messageDiv.className = "message";
                                                // 根據角色設置不同的 class
                                                const bubbleClass = msg.role === 'user' ? 'user' : 'bot';
                                                messageDiv.innerHTML = `<div class="message-bubble ${bubbleClass}">${msg.content}</div>`;
                                                chatBox.appendChild(messageDiv);
                                            });
                                        }
                                    }
                                    chatBox.scrollTop = chatBox.scrollHeight;
                                });
                        });

                    }

                    // **添加ai訊息**
                    let aiMessage = document.createElement("div");
                    aiMessage.className = "message";
                    aiMessage.innerHTML = `<div class="message-bubble bot">${data.ai_response}</div>`;
                    chatBox.appendChild(aiMessage);

                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            })
            .catch(error => console.error("error: ", error));
        }

        // 添加新對話按鈕的事件監聽器
        document.getElementById("newChatBtn").addEventListener("click", function() {
            // 發送請求到後端創建新對話
            fetch("/createNewConversation/", {
                method: "POST",
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === "Success") {
                    
                    // 清空聊天框
                    document.getElementById("chatBox").innerHTML = "";
                    // 清空輸入框
                    document.getElementById("userInputEditBox").value = "";
                    //如果是新對話
                    if(data.need_add_new_conv) {
                        let conv_row = document.createElement("div");
                        conv_row.innerHTML = `<div class="conversation-item">${userInputText}</div>`;
                        const firstDiv = document.querySelector('.conversation-list div');
                        if (firstDiv.id === "") {
                            firstDiv.id = data.conv_id;
                        }
                        // 在列表的頂部插入新對話，而不是附加到底部
                        conv_list.insertBefore(conv_row, conv_list.firstChild);
                    }console.error("Failed to create new conversation:", data.error);
                }
            })
            .catch(error => {
                console.error("Error creating new conversation:", error);
            });
        });

    </script>
</body>
</html>
