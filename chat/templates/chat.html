{% load static %}
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbox</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Chat History</h2>
            <button id="newChatBtn" class="new-chat-btn">+</button>
        </div>
        <div class="conversation-list" id="conv_list">
            <!-- conservation-item will be displayed here -->
        </div>   
    </div>

    <div class="main-content">
        <div class="chatbox-header">
            <h2>AIChatBot</h2>
        </div>
        <div class="chatbox-messages" id="chatBox">
            <!-- Messages will be displayed here -->
        </div>
        <div class="chatbox-input">
            <textarea id="userInputEditBox" placeholder="輸入訊息..." ></textarea>
            <div class="footer">
                <button class="send-btn" onclick="sendMessage()">↑</button>
            </div>
        </div>
    </div>

    <script>
        let isChiInput = false;

        // 頁面載入時執行
        document.addEventListener('DOMContentLoaded', function() {
            // 載入歷史對話列表
            loadAllConversationToSideBar();
        });

        // 載入歷史對話列表
        function loadAllConversationToSideBar() {
            fetch('/api/load_all_conversation_to_sidebar/', {
                method: 'GET',
            })
            .then(response => response.json())
            .then(data => {
                if (data.conversations) {
                    const convList = document.getElementById('conv_list');
                    data.conversations.forEach(conv => {
                        addNewConversationRowInSideBar(conv.id, conv.title);
                        
                    });
                }
            })
            .catch(error => console.error("Error loading conversation history:", error));
        }

        document.getElementById("userInputEditBox").addEventListener("compositionstart", function(event) {
            isChiInput = true;
        });

        document.getElementById("userInputEditBox").addEventListener("compositionend", function(event) {
            isChiInput = false;
        });

        document.getElementById("userInputEditBox").addEventListener("keydown", function(event) {
            if (event.key === "Enter" && !event.shiftKey && !isChiInput) {
                event.preventDefault();
                sendMessage();
            }
        });

        function sendMessage() {
            const conv_list = document.querySelector(".conversation-list"); // 使用 querySelector 來獲取單個元素
            const divs = conv_list.querySelectorAll('div'); // 然後在該元素內部查找所有 div

            let userInputEditBox = document.getElementById("userInputEditBox");
            let userInputText = userInputEditBox.value.trim();
            if (userInputText === "") return;
            userInputEditBox.value = "";

            let chatBox = document.getElementById("chatBox");

            // **添加用戶訊息**
            let userMessage = document.createElement("div");
            userMessage.className = "message";
            userMessage.innerHTML = `<div class="message-bubble user">${userInputText}</div>`;
            chatBox.appendChild(userMessage);

            // 滾動到最新的消息
            chatBox.scrollTop = chatBox.scrollHeight;

            // 預先建立 ai 訊息容器，之後串流更新
            let aiMessage = document.createElement("div");
            aiMessage.className = "message";
            const aiBubble = document.createElement("div");
            aiBubble.className = "message-bubble bot";
            aiBubble.textContent = "...";
            aiMessage.appendChild(aiBubble);
            chatBox.appendChild(aiMessage);

            let formData = new FormData();
            formData.append("userInputText", userInputText);
            
            // 將所有 div 的 id 存入 FormData
            Array.from(divs).forEach((div, index) => {
                formData.append(`conv_id_${index}`, div.id);  // 使用唯一的鍵名來區分每個 div id
            });

            // 串流請求
            fetch("/sendMessageStream/", {
                method: "POST",
                body: formData
            })
            .then(async response => {
                if (!response.body) {
                    aiBubble.textContent = "串流失敗：無回應內容";
                    return;
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = "";
                let aiText = "";
                let metaHandled = false;

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });

                    // 逐行處理 JSON event
                    let newlineIndex;
                    while ((newlineIndex = buffer.indexOf("\n")) >= 0) {
                        const line = buffer.slice(0, newlineIndex).trim();
                        buffer = buffer.slice(newlineIndex + 1);
                        if (!line) continue;
                        try {
                            const event = JSON.parse(line);
                            if (event.event === "meta" && !metaHandled) {
                                metaHandled = true;
                                const convId = event.conv_id;
                                const needNewRow = event.is_curr_conv_id_not_in_side_bar;
                                let firstItem = document.querySelector(".conversation-list").firstElementChild;

                                if (firstItem == null || firstItem.id !== convId) {
                                    let rowTitle = userInputText;
                                    if (needNewRow) {
                                        // 新對話，直接用問句當標題
                                        console.log("new conv id:", convId);
                                    } else {
                                        // 舊對話重聊，移到最上面
                                        let oldChat = document.querySelector(`.conversation-item[id="${convId}"]`);
                                        if (oldChat) {
                                            const titleContainer = oldChat.querySelector('.conversation-title');
                                            if (titleContainer) {
                                                rowTitle = titleContainer.textContent;
                                            }
                                            oldChat.remove();
                                        }
                                    }
                                    addNewConversationRowInSideBar(convId, rowTitle);
                                }
                            } else if (event.event === "delta") {
                                aiText += event.token;
                                aiBubble.textContent = aiText;
                                chatBox.scrollTop = chatBox.scrollHeight;
                            } else if (event.event === "error") {
                                aiBubble.textContent = `錯誤：${event.message || '未知錯誤'}`;
                            }
                        } catch (err) {
                            console.error("parse stream error:", err, line);
                        }
                    }
                }
                aiBubble.textContent = aiText || aiBubble.textContent;
                chatBox.scrollTop = chatBox.scrollHeight;
            })
            .catch(error => {
                console.error("error: ", error);
                aiBubble.textContent = "串流失敗：" + error;
            });
        }

        // 添加新對話按鈕的事件監聽器
        document.getElementById("newChatBtn").addEventListener("click", function() {
            // 發送請求到後端創建新對話
            fetch("/createNewConversation/", {
                method: "POST",
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === "Success") {
                    // 清空聊天框
                    document.getElementById("chatBox").innerHTML = "";
                    // 清空輸入框
                    document.getElementById("userInputEditBox").value = "";
                }
            })
            .catch(error => {
                console.error("Error creating new conversation:", error);
            });
        });

        function addNewConversationRowInSideBar(conversationId, conversationTitle) {
            let convRow = document.createElement("div");
            convRow.className = "conversation-item";
            convRow.id = conversationId;
            
            // 創建對話標題容器
            let titleContainer = document.createElement("div");
            titleContainer.className = "conversation-title";
            titleContainer.textContent = conversationTitle;
            
            // 三個點按鈕
            let threeDotsBtn = document.createElement("button");
            threeDotsBtn.className = "three-dots-btn";
            threeDotsBtn.innerHTML = "⋯";
            threeDotsBtn.style.display = "none"; // 預設隱藏
            
            // 創建下拉選單
            let dropdownMenu = document.createElement("div");
            dropdownMenu.className = "dropdown-menu";
            dropdownMenu.innerHTML = `
                <div class="dropdown-item" onclick="renameConversation('${conversationId}')">重新命名</div>
                <div class="dropdown-item" onclick="deleteConversation('${conversationId}')">刪除</div>
            `;
            dropdownMenu.style.display = "none"; // 預設隱藏
            
            // 組裝對話項目
            convRow.appendChild(titleContainer);
            convRow.appendChild(threeDotsBtn);
            convRow.appendChild(dropdownMenu);
            
            // 添加 hover 事件
            convRow.addEventListener("mouseenter", function() {
                threeDotsBtn.style.display = "block";
            });
            
            convRow.addEventListener("mouseleave", function() {
                threeDotsBtn.style.display = "none";
                dropdownMenu.style.display = "none";
            });
            
            // 三個點
            threeDotsBtn.addEventListener("click", function(e) {
                e.stopPropagation(); // 防止觸發對話項目的點擊事件
                dropdownMenu.style.display = dropdownMenu.style.display === "none" ? "block" : "none";
            });
            
            // 點擊其他地方關閉下拉選單
            document.addEventListener("click", function(e) {
                if (!convRow.contains(e.target)) {
                    dropdownMenu.style.display = "none";
                }
            });
            
            conv_list.insertBefore(convRow, conv_list.firstChild);
            
            // 綁定點擊事件
            convRow.addEventListener("click", function() {
                fetch(`/api/load_conv/${conversationId}`, {
                    method: "GET",
                })
                .then(res => res.json())
                .then(data => {
                    const chatBox = document.getElementById("chatBox");
                    
                    if (data.need_clear_chatbox === "true") {
                        chatBox.innerHTML = "";
                        if (data.conversation_history) {
                            data.conversation_history.forEach(msg => {
                                let messageDiv = document.createElement("div");
                                messageDiv.className = "message";
                                const bubbleClass = msg.role === 'user' ? 'user' : 'bot';
                                messageDiv.innerHTML = `<div class="message-bubble ${bubbleClass}">${msg.content}</div>`;
                                chatBox.appendChild(messageDiv);
                            });
                        }
                    }
                    highlightCurrentConversation(conversationId);
                    chatBox.scrollTop = chatBox.scrollHeight;
                });
            });
        }
        
        function highlightCurrentConversation(convId) {
            // 先移除所有 active 樣式
            document.querySelectorAll('.conversation-item.active').forEach(item => {
                item.classList.remove('active');
            });
            // 給當前的加上 active
            let current = document.getElementById(convId);
            if (current) {
                current.classList.add('active');
            }
        }

        function renameConversation(convId) {
            const newTitle = prompt("輸入新的對話標題：");
            if (newTitle && newTitle.trim() !== "") {
                const convItem = document.getElementById(convId);
                if (convItem) {
                    const titleContainer = convItem.querySelector('.conversation-title');
                    if (titleContainer) {
                        titleContainer.textContent = newTitle.trim();
                    }
                }
                
                // 這裡可以添加後端 API 調用來保存新的標題
                console.log(`Renamed conversation ${convId} to: ${newTitle}`);
            }
        }
        
        function deleteConversation(convId) {
            if (confirm("確定要刪除？")) {
                const convItem = document.getElementById(convId);
                if (convItem) {
                    convItem.remove();
                }
                
                console.log(`Deleted conversation: ${convId}`);
            }
        }

    </script>
</body>
</html>
