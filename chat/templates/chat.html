{% load static %}
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbox</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Chat History</h2>
            <button id="newChatBtn" class="new-chat-btn">+</button>
        </div>
        <div class="conversation-list">
            <span id=""></span>
            <span id="actualUuid">hi</span>
        </div>   
    </div>

    <div class="main-content">
        <div class="chatbox-header">
            <h2>AIChatBot</h2>
        </div>
        <div class="chatbox-messages" id="chatBox">
            <!-- Messages will be displayed here -->
        </div>
        <div class="chatbox-input">
            <textarea id="userInputEditBox" placeholder="輸入訊息..." ></textarea>
            <div class="footer">
                <button class="send-btn" onclick="sendMessage()">↑</button>
            </div>
        </div>
    </div>

    <script>
        let isChiInput = false;

        // 添加自動調整文本框高度的功能
        const ta = document.getElementById('userInputEditBox');
        ta.addEventListener('input', () => {
            ta.style.height = 'auto';           // 先歸零
            ta.style.height = ta.scrollHeight + 'px'; // 以內容高度為準
        });

        document.getElementById("userInputEditBox").addEventListener("compositionstart", function(event) {
            isChiInput = true;
        });

        document.getElementById("userInputEditBox").addEventListener("compositionend", function(event) {
            isChiInput = false;
        });

        document.getElementById("userInputEditBox").addEventListener("keydown", function(event) {
            if (event.key === "Enter" && !event.shiftKey && !isChiInput) {
                event.preventDefault();
                sendMessage();
            }
        });

        function sendMessage() {
            let conv_list = document.querySelector(".conversation-list"); // 使用 querySelector 來獲取單個元素
            console.log(conv_list);
            let spans = conv_list.querySelectorAll('span'); // 然後在該元素內部查找所有 span
            console.log(spans);
            let userInputEditBox = document.getElementById("userInputEditBox");
            let userInputText = userInputEditBox.value.trim();
            if (userInputText === "") return;
            userInputEditBox.value = "";

            let chatBox = document.getElementById("chatBox");

            // **添加用戶訊息**
            let userMessage = document.createElement("div");
            userMessage.className = "message";
            userMessage.innerHTML = `<div class="message-bubble user">${userInputText}</div>`;
            chatBox.appendChild(userMessage);

            // 滾動到最新的消息
            chatBox.scrollTop = chatBox.scrollHeight;

            // 在發送請求前，先創建一個 "..." 的訊息並且開始動畫
            let loadingMessage = document.createElement("div");
            loadingMessage.className = "message";
            loadingMessage.innerHTML = `<div class="message-bubble bot">.</div>`;
            chatBox.appendChild(loadingMessage);

            // 動態更新 loadingMessage 的內容
            let dots = 1;
            let loadingInterval = setInterval(() => {
                dots = (dots % 3) + 1;  // 控制點數在 1 到 3 之間變化
                loadingMessage.innerHTML = `<div class="message-bubble bot">${".".repeat(dots)}</div>`;
            }, 500); // 每 500 毫秒更新一次

            let formData = new FormData();
            formData.append("userInputText", userInputText);
            
            // 將所有 div 的 id 存入 FormData
            Array.from(spans).forEach((span, index) => {
                formData.append(`conv_id_${index}`, span.id);  // 使用唯一的鍵名來區分每個 div id
            });

            // AJAX 請求
            fetch("/sendMessage/", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === "Success") {
                    clearInterval(loadingInterval); // 停止更新動畫
                    chatBox.removeChild(loadingMessage);

                    // **添加ai訊息**
                    let aiMessage = document.createElement("div");
                    aiMessage.className = "message";
                    aiMessage.innerHTML = `<div class="message-bubble bot">${data.ai_response}</div>`;
                    chatBox.appendChild(aiMessage);

                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            })
            .catch(error => console.error("error: ", error));
        }

        // 添加新對話按鈕的事件監聽器
        document.getElementById("newChatBtn").addEventListener("click", function() {
            // 發送請求到後端創建新對話
            fetch("/createNewConversation/", {
                method: "POST",
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === "Success") {
                    
                    // 清空聊天框
                    document.getElementById("chatBox").innerHTML = "";
                    // 清空輸入框
                    document.getElementById("userInputEditBox").value = "";
                    //更新對話 ID
                    //document.getElementById("uuidxxx").id = data.conversation_id;

                    // 抓「conversation-list」裡第一個 <span>
                    const firstSpan = document.querySelector('.conversation-list span');
                    if (firstSpan.id === "") {
                        firstSpan.id = data.conversation_id;
                    }


                } else {
                    console.error("Failed to create new conversation:", data.error);
                }
            })
            .catch(error => {
                console.error("Error creating new conversation:", error);
            });
        });

    </script>
</body>
</html>
