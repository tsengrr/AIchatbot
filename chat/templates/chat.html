{% load static %}
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbox</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Chat History</h2>
            <button id="newChatBtn" class="new-chat-btn">+</button>
        </div>
        <div class="conversation-list" id="conv_list">
            <!-- conservation-item will be displayed here -->
        </div>   
    </div>

    <div class="main-content">
        <div class="chatbox-header">
            <h2>Movie/Book Recommander</h2>
        </div>
        <div class="chatbox-messages" id="chatBox">
            <!-- Messages will be displayed here -->
        </div>
        <div class="chatbox-input">
            <textarea id="userInputEditBox" placeholder="輸入訊息..." ></textarea>
            <select id="chatMode" class="mode-select">
                <option value="general">綜合閒聊 (預設)</option>
                <option value="movie">電影模式 (影評人)</option>
                <option value="book">書籍模式 (圖書館員)</option>
            </select>
            <div class="footer">
                <button class="send-btn" onclick="sendMessage()">↑</button>
            </div>
        </div>
    </div>

    <script>
        let isChiInput = false;

        // 頁面載入時執行
        document.addEventListener('DOMContentLoaded', function() {
            // 載入歷史對話列表
            loadAllConversationToSideBar();
        });

        // 載入歷史對話列表
        function loadAllConversationToSideBar() {
            fetch('/api/load_all_conversation_to_sidebar/', {
                method: 'GET',
            })
            .then(response => response.json())
            .then(data => {
                if (data.conversations) {
                    const convList = document.getElementById('conv_list');
                    data.conversations.forEach(conv => {
                        addNewConversationRowInSideBar(conv.id, conv.title);
                        
                    });
                }
            })
            .catch(error => console.error("Error loading conversation history:", error));
        }

        document.getElementById("userInputEditBox").addEventListener("compositionstart", function(event) {
            isChiInput = true;
        });

        document.getElementById("userInputEditBox").addEventListener("compositionend", function(event) {
            isChiInput = false;
        });

        document.getElementById("userInputEditBox").addEventListener("keydown", function(event) {
            if (event.key === "Enter" && !event.shiftKey && !isChiInput) {
                event.preventDefault();
                sendMessage();
            }
        });

        function sendMessage() {
            let conv_list = document.querySelector(".conversation-list"); // 使用 querySelector 來獲取單個元素
            console.log(conv_list);
            let divs = conv_list.querySelectorAll('div'); // 然後在該元素內部查找所有 div
            console.log(divs);

            let userInputEditBox = document.getElementById("userInputEditBox");
            let userInputText = userInputEditBox.value.trim();
            let mode = document.getElementById("chatMode").value;
            if (userInputText === "") return;
            userInputEditBox.value = "";

            let chatBox = document.getElementById("chatBox");

            // **添加用戶訊息**
            let userMessage = document.createElement("div");
            userMessage.className = "message";
            userMessage.innerHTML = `<div class="message-bubble user">${userInputText}</div>`;
            chatBox.appendChild(userMessage);

            // 滾動到最新的消息
            chatBox.scrollTop = chatBox.scrollHeight;

            // 在發送請求前，先創建一個 "..." 的訊息並且開始動畫
            let loadingMessage = document.createElement("div");
            loadingMessage.className = "message";
            loadingMessage.innerHTML = `<div class="message-bubble bot">.</div>`;
            chatBox.appendChild(loadingMessage);

            // 動態更新 loadingMessage 的內容
            let dots = 1;
            let loadingInterval = setInterval(() => {
                dots = (dots % 3) + 1;  // 控制點數在 1 到 3 之間變化
                loadingMessage.innerHTML = `<div class="message-bubble bot">${".".repeat(dots)}</div>`;
            }, 500); // 每 500 毫秒更新一次

            let formData = new FormData();
            formData.append("userInputText", userInputText);
            formData.append("mode", mode);
            
            // 將所有 div 的 id 存入 FormData
            Array.from(divs).forEach((div, index) => {
                formData.append(`conv_id_${index}`, div.id);  // 使用唯一的鍵名來區分每個 div id
            });

            // AJAX 請求
            fetch("/sendMessage/", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === "Success") {
                    clearInterval(loadingInterval); 
                    chatBox.removeChild(loadingMessage);
                    let firstItem = document.querySelector(".conversation-list").firstElementChild;

                    // if first row is current row, not need to add new row or remove any exist row
                    if (firstItem == null || firstItem.id != data.conv_id){
                        rowTitle = userInputText;

                        if (data.is_curr_conv_id_not_in_side_bar) {
                            // first message after create new conversation, should add one row
                            console.log("data.conv_id:", data.conv_id);
                            
                        }else{
                            // old chat re-chat, should move it to newest
                            let oldChat = document.querySelector(`.conversation-item[id="${data.conv_id}"]`);
                            let rowTitle = userInputText;
                            if (oldChat) {
                                const titleContainer = oldChat.querySelector('.conversation-title');
                                if (titleContainer) {
                                    rowTitle = titleContainer.textContent;
                                }
                                oldChat.remove();
                            }                        
                        }
                        addNewConversationRowInSideBar(data.conv_id, rowTitle);

                    }

                    // **添加ai訊息**
                    let aiMessage = document.createElement("div");
                    aiMessage.className = "message";
                    aiMessage.innerHTML = `<div class="message-bubble bot">${data.ai_response}</div>`;
                    chatBox.appendChild(aiMessage);

                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            })
            .catch(error => console.error("error: ", error));
        }

        // 添加新對話按鈕的事件監聽器
        document.getElementById("newChatBtn").addEventListener("click", function() {
            // 發送請求到後端創建新對話
            fetch("/createNewConversation/", {
                method: "POST",
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === "Success") {
                    // 清空聊天框
                    document.getElementById("chatBox").innerHTML = "";
                    // 清空輸入框
                    document.getElementById("userInputEditBox").value = "";
                }
            })
            .catch(error => {
                console.error("Error creating new conversation:", error);
            });
        });

        function addNewConversationRowInSideBar(conversationId, conversationTitle) {
            let convRow = document.createElement("div");
            convRow.className = "conversation-item";
            convRow.id = conversationId;
            
            // 創建對話標題容器
            let titleContainer = document.createElement("div");
            titleContainer.className = "conversation-title";
            titleContainer.textContent = conversationTitle;
            
            // 三個點按鈕
            let threeDotsBtn = document.createElement("button");
            threeDotsBtn.className = "three-dots-btn";
            threeDotsBtn.innerHTML = "⋯";
            threeDotsBtn.style.display = "none"; // 預設隱藏
            
            // 創建下拉選單
            let dropdownMenu = document.createElement("div");
            dropdownMenu.className = "dropdown-menu";
            dropdownMenu.innerHTML = `
                <div class="dropdown-item" onclick="renameConversation('${conversationId}')">重新命名</div>
                <div class="dropdown-item" onclick="deleteConversation('${conversationId}')">刪除</div>
            `;
            dropdownMenu.style.display = "none"; // 預設隱藏
            
            // 組裝對話項目
            convRow.appendChild(titleContainer);
            convRow.appendChild(threeDotsBtn);
            convRow.appendChild(dropdownMenu);
            
            // 添加 hover 事件
            convRow.addEventListener("mouseenter", function() {
                threeDotsBtn.style.display = "block";
            });
            
            convRow.addEventListener("mouseleave", function() {
                threeDotsBtn.style.display = "none";
                dropdownMenu.style.display = "none";
            });
            
            // 三個點
            threeDotsBtn.addEventListener("click", function(e) {
                e.stopPropagation(); // 防止觸發對話項目的點擊事件
                dropdownMenu.style.display = dropdownMenu.style.display === "none" ? "block" : "none";
            });
            
            // 點擊其他地方關閉下拉選單
            document.addEventListener("click", function(e) {
                if (!convRow.contains(e.target)) {
                    dropdownMenu.style.display = "none";
                }
            });
            
            conv_list.insertBefore(convRow, conv_list.firstChild);
            
            // 綁定點擊事件
            convRow.addEventListener("click", function() {
                fetch(`/api/load_conv/${conversationId}`, {
                    method: "GET",
                })
                .then(res => res.json())
                .then(data => {
                    const chatBox = document.getElementById("chatBox");
                    
                    if (data.need_clear_chatbox === "true") {
                        chatBox.innerHTML = "";
                        if (data.conversation_history) {
                            data.conversation_history.forEach(msg => {
                                let messageDiv = document.createElement("div");
                                messageDiv.className = "message";
                                const bubbleClass = msg.role === 'user' ? 'user' : 'bot';
                                messageDiv.innerHTML = `<div class="message-bubble ${bubbleClass}">${msg.content}</div>`;
                                chatBox.appendChild(messageDiv);
                            });
                        }
                    }
                    highlightCurrentConversation(conversationId);
                    chatBox.scrollTop = chatBox.scrollHeight;
                });
            });
        }
        
        function highlightCurrentConversation(convId) {
            // 先移除所有 active 樣式
            document.querySelectorAll('.conversation-item.active').forEach(item => {
                item.classList.remove('active');
            });
            // 給當前的加上 active
            let current = document.getElementById(convId);
            if (current) {
                current.classList.add('active');
            }
        }

        function renameConversation(convId) {
            const newTitle = prompt("輸入新的對話標題：");
            if (newTitle && newTitle.trim() !== "") {
                const convItem = document.getElementById(convId);
                if (convItem) {
                    const titleContainer = convItem.querySelector('.conversation-title');
                    if (titleContainer) {
                        titleContainer.textContent = newTitle.trim();
                    }
                }
                
                // 這裡可以添加後端 API 調用來保存新的標題
                console.log(`Renamed conversation ${convId} to: ${newTitle}`);
            }
        }
        
        function deleteConversation(convId) {
            if (confirm("確定要刪除？")) {
                const convItem = document.getElementById(convId);
                if (convItem) {
                    convItem.remove();
                }
                
                console.log(`Deleted conversation: ${convId}`);
            }
        }

    </script>
</body>
</html>
